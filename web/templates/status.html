<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>{% if token_name and token_name.upper() != 'NONE' %}{{ token_name }} - Status{% else %}Status Page{% endif %}</title>
    <link rel="stylesheet" href="/static/css/status.css?v=1760818300&bust={{ range(1, 9999999) | random }}">
</head>
<body>
    <div class="status-page">
        <!-- Floating Dashboard Link - Hidden since we now have tabs -->
        <a href="/public/{{ token }}/dashboard" class="floating-dashboard-link" style="display: none;">
            <span class="link-text">Card View</span>
            <span class="link-arrow">→</span>
        </a>

        <header class="status-header">
            {% if token_name and token_name.upper() != 'NONE' %}
            <h1 class="status-title" data-text="{{ token_name }}">{{ token_name }}</h1>
            {% endif %}
            <div class="overall-status" id="overallStatus">
                <div class="status-indicator loading">
                    <span class="status-dot"></span>
                    <span class="status-text">Loading...</span>
                </div>
            </div>

            <!-- View Switcher Tabs (only show if view_mode is 'both') -->
            {% if view_mode == 'both' %}
            <div class="view-switcher">
                <button class="view-tab active" data-view="timeline">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18M7 16l4-4 4 4 6-6"/>
                    </svg>
                    Timeline
                </button>
                <button class="view-tab" data-view="cards">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                    Cards
                </button>
            </div>
            {% endif %}
        </header>

        <main class="status-main">
            {% if has_targets %}
            <!-- Timeline View -->
            <div class="view-content {% if view_mode == 'timeline' or view_mode == 'both' %}active{% endif %}" id="timelineView" style="{% if view_mode == 'cards' %}display: none;{% endif %}">
                <div class="timeline-filters">
                    <button class="filter-btn active" data-range="24h">24 Hours</button>
                    <button class="filter-btn" data-range="7d">7 Days</button>
                    <button class="filter-btn" data-range="30d">30 Days</button>
                    <button class="filter-btn" data-range="90d">90 Days</button>
                </div>

                <div class="timeline-grid" id="timelineGrid">
                    <div class="loading-placeholder">
                        <div class="spinner"></div>
                        <p>Loading timeline...</p>
                    </div>
                </div>
            </div>

            <!-- Cards View -->
            <div class="view-content {% if view_mode == 'cards' %}active{% endif %}" id="cardsView" style="{% if view_mode == 'timeline' %}display: none;{% endif %}">
                <div class="services-container" id="servicesContainer">
                    <div class="loading-placeholder">
                        <div class="spinner"></div>
                        <p>Loading services...</p>
                    </div>
                </div>
            </div>
            {% else %}
            <section class="no-services">
                <div class="no-services-message">
                    <p>No services are currently being monitored on this status page.</p>
                </div>
            </section>
            {% endif %}

            <!-- Recent Incidents Section -->
            {% if has_targets %}
            <section class="incidents-section" id="incidentsSection">
                <h2 class="incidents-title">Recent Incidents (Past 14 Days)</h2>
                <div class="incidents-container" id="incidentsContainer">
                    <div class="loading-placeholder">
                        <div class="spinner"></div>
                        <p>Loading incidents...</p>
                    </div>
                </div>
                <button class="show-more-btn" id="showMoreBtn" style="display: none;">
                    Show More
                </button>
            </section>
            {% endif %}
        </main>

        <footer class="status-footer">
            <p>
                Last updated: <span id="lastUpdated">--</span>
                <span class="auto-refresh-indicator" title="Auto-refreshes every 30 seconds">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                </span>
                <button class="theme-toggle-inline" id="themeToggle" aria-label="Toggle theme" title="Toggle theme">
                    <svg class="sun-icon" width="14" height="14" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg class="moon-icon" width="14" height="14" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
            </p>
        </footer>
    </div>

    <script>
        const TOKEN = '{{ token }}';
        const STATUS_API = `/api/v1/public/${TOKEN}/status`;
        const HISTORY_API = `/api/v1/public/${TOKEN}/history`;
        const INCIDENTS_API = `/api/v1/public/${TOKEN}/incidents`;
        const REFRESH_INTERVAL = 30000; // 30 seconds
        const VIEW_MODE = '{{ view_mode }}'; // 'both', 'timeline', or 'cards'
        let refreshTimer = null;
        let currentRange = '24h';
        let currentView = VIEW_MODE === 'cards' ? 'cards' : 'timeline'; // Set initial view based on mode
        let statusData = null; // Store status data for cards view

        // Theme Management
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        const sunIcon = themeToggle.querySelector('.sun-icon');
        const moonIcon = themeToggle.querySelector('.moon-icon');

        // Get saved theme or system preference
        function getInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                return savedTheme;
            }
            // Check system preference
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        // Set theme
        function setTheme(theme) {
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);

            // Update icon
            if (theme === 'dark') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        }

        // Toggle theme
        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        // Initialize theme before page renders
        setTheme(getInitialTheme());

        // Format date/time to readable format
        function formatDateTime(isoString) {
            if (!isoString) return '--';
            try {
                const date = new Date(isoString);
                return date.toLocaleString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '--';
            }
        }

        // Format time only (for tooltips)
        function formatTime(date) {
            if (!date) return '--';
            try {
                return date.toLocaleString(undefined, {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '--';
            }
        }

        // Format relative time (e.g., "5 minutes ago")
        function formatRelativeTime(isoString) {
            if (!isoString) return '--';
            try {
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } catch (e) {
                return '--';
            }
        }

        // Render overall status indicator
        function renderOverallStatus(data) {
            const container = document.getElementById('overallStatus');
            const statusMap = {
                'operational': {
                    text: 'All Systems Operational',
                    class: 'operational',
                    icon: '✓'
                },
                'partial_outage': {
                    text: 'Partial System Outage',
                    class: 'degraded',
                    icon: '!'
                },
                'major_outage': {
                    text: 'System Outage',
                    class: 'down',
                    icon: '×'
                },
                'no_data': {
                    text: 'No Data Available',
                    class: 'unknown',
                    icon: '?'
                }
            };

            const status = statusMap[data.overall_status] || statusMap['no_data'];

            container.innerHTML = `
                <div class="status-indicator ${status.class}">
                    <span class="status-dot">${status.icon}</span>
                    <span class="status-text">${status.text}</span>
                </div>
            `;
        }

        // Render timeline view
        function renderTimeline(historyData) {
            const container = document.getElementById('timelineGrid');

            if (!historyData || historyData.length === 0) {
                container.innerHTML = `
                    <div class="no-services-message">
                        <p>No timeline data available.</p>
                    </div>
                `;
                return;
            }

            const rows = historyData.map(target => {
                const uptime = target.uptime_percentage || 0;

                // Generate timeline pills from bucketed history
                let bars = '';
                let currentStatus = 'unknown';
                if (target.history && target.history.length > 0) {
                    bars = target.history.map(point => {
                        const status = point.status || 'unknown';
                        const startTime = new Date(point.timestamp);
                        const endTime = point.end_timestamp ? new Date(point.end_timestamp) : null;
                        const checksCount = point.checks_count || 0;

                        // Build tooltip with bucket info
                        let tooltip = `${formatTime(startTime)}`;
                        if (endTime) {
                            tooltip += ` - ${formatTime(endTime)}`;
                        }
                        tooltip += `\nStatus: ${status.toUpperCase()}`;
                        if (checksCount > 0) {
                            tooltip += `\nChecks: ${checksCount}`;
                        }

                        return `<div class="timeline-pill status-${status}" title="${tooltip}"></div>`;
                    }).join('');

                    // Get the most recent status from buckets that have data (checks_count > 0)
                    // Iterate backwards to find the last bucket with actual data
                    for (let i = target.history.length - 1; i >= 0; i--) {
                        if (target.history[i].checks_count > 0) {
                            currentStatus = target.history[i].status || 'unknown';
                            break;
                        }
                    }
                } else {
                    bars = '<div class="timeline-pill status-unknown" style="flex: 1;"></div>';
                }

                // Determine current status badge based on most recent data
                const statusBadge = currentStatus === 'up'
                    ? '<span class="status-badge operational">UP</span>'
                    : currentStatus === 'down'
                    ? '<span class="status-badge down">DOWN</span>'
                    : '<span class="status-badge unknown">UNKNOWN</span>';

                return `
                    <div class="timeline-row">
                        <div class="timeline-header">
                            <h3 class="timeline-target-name">${escapeHtml(target.name)}</h3>
                            <span class="timeline-uptime">${uptime.toFixed(2)}%</span>
                        </div>
                        <div class="timeline-chart">
                            ${bars}
                        </div>
                        <div class="timeline-legend">
                            ${statusBadge}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = rows;
        }

        // Render service cards view
        function renderServiceCards(statusData) {
            const container = document.getElementById('servicesContainer');

            // Handle different possible data structures
            const targets = statusData?.targets || statusData?.services || [];

            if (!targets || targets.length === 0) {
                container.innerHTML = `
                    <div class="no-services-message">
                        <p>No services available.</p>
                    </div>
                `;
                return;
            }

            const cards = targets.map(target => {
                const statusClass = target.status === 'up' ? 'operational' :
                                  target.status === 'down' ? 'down' : 'unknown';
                const statusText = target.status === 'up' ? 'Operational' :
                                 target.status === 'down' ? 'Down' : 'Unknown';

                return `
                    <div class="service-card ${statusClass}">
                        <div class="service-header">
                            <h3 class="service-name">${escapeHtml(target.name)}</h3>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = cards;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load status data from API
        async function loadStatus() {
            try {
                const response = await fetch(STATUS_API);

                if (!response.ok) {
                    if (response.status === 429) {
                        showError('Rate limit exceeded. Please wait before refreshing.');
                        stopAutoRefresh();
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                statusData = data; // Store for cards view

                // Render overall status
                renderOverallStatus(data);

                // Update timestamp
                document.getElementById('lastUpdated').textContent = formatDateTime(data.last_updated);

                // If cards view is active, render the cards
                if (currentView === 'cards') {
                    renderServiceCards(data);
                }

            } catch (error) {
                console.error('Error loading status:', error);
                showError('Unable to load status. Retrying...');
            }
        }

        // Load timeline data
        async function loadTimeline() {
            try {
                const response = await fetch(`${HISTORY_API}?range=${currentRange}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                // Handle both array and object responses
                const historyData = Array.isArray(data) ? data : (data.targets || data.services || []);
                renderTimeline(historyData);

            } catch (error) {
                console.error('Error loading timeline:', error);
                showError('Unable to load timeline data.');
            }
        }

        // Store all incidents for show more functionality
        let allIncidents = [];
        let showingAllIncidents = false;
        const INITIAL_INCIDENT_COUNT = 10;

        // Load and render incidents
        async function loadIncidents() {
            try {
                const response = await fetch(`${INCIDENTS_API}?days=14`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                allIncidents = data.incidents || [];
                renderIncidents(allIncidents, false);

            } catch (error) {
                console.error('Error loading incidents:', error);
                const container = document.getElementById('incidentsContainer');
                container.innerHTML = `
                    <div class="no-incidents">
                        <p>Unable to load incident data.</p>
                    </div>
                `;
            }
        }

        // Render incidents list
        function renderIncidents(incidents, showAll = false) {
            const container = document.getElementById('incidentsContainer');
            const showMoreBtn = document.getElementById('showMoreBtn');

            if (!incidents || incidents.length === 0) {
                container.innerHTML = `
                    <div class="no-incidents">
                        <p>No incidents in the past 14 days</p>
                    </div>
                `;
                showMoreBtn.style.display = 'none';
                return;
            }

            // Determine how many incidents to show
            const incidentsToShow = showAll ? incidents : incidents.slice(0, INITIAL_INCIDENT_COUNT);

            const incidentItems = incidentsToShow.map(incident => {
                const statusClass = incident.status === 'resolved' ? 'resolved' : 'ongoing';
                const statusText = incident.status === 'resolved' ? 'Resolved' : 'Ongoing';
                const statusIcon = incident.status === 'resolved' ? '✓' : '⚠';

                return `
                    <div class="incident-item ${statusClass}">
                        <div class="incident-header">
                            <div class="incident-status-indicator ${statusClass}">
                                <span class="incident-icon">${statusIcon}</span>
                            </div>
                            <div class="incident-details">
                                <h3 class="incident-title">${escapeHtml(incident.title)}</h3>
                                <div class="incident-meta">
                                    <span class="incident-time">${formatDateTime(incident.started_at)}</span>
                                    <span class="incident-separator">•</span>
                                    <span class="incident-duration">${escapeHtml(incident.duration)}</span>
                                    <span class="incident-separator">•</span>
                                    <span class="incident-status ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = incidentItems;

            // Show/hide "Show More" button
            if (incidents.length > INITIAL_INCIDENT_COUNT && !showAll) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.textContent = `Show More (${incidents.length - INITIAL_INCIDENT_COUNT} more)`;
            } else if (incidents.length > INITIAL_INCIDENT_COUNT && showAll) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.textContent = 'Show Less';
            } else {
                showMoreBtn.style.display = 'none';
            }
        }

        // Toggle show more/less incidents
        function toggleShowMore() {
            showingAllIncidents = !showingAllIncidents;
            renderIncidents(allIncidents, showingAllIncidents);
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('timelineGrid');
            container.innerHTML = `
                <div class="loading-placeholder">
                    <p style="color: var(--danger);">${escapeHtml(message)}</p>
                </div>
            `;
        }

        // Clear error state
        function clearError() {
            // Error handling is implicit - successful render clears errors
        }

        // Start auto-refresh
        function startAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            refreshTimer = setInterval(loadStatus, REFRESH_INTERVAL);
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
        }

        // Handle visibility change (pause refresh when tab hidden)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                loadStatus();
                startAutoRefresh();
            }
        });

        // Switch between timeline and cards view
        function switchView(viewName) {
            currentView = viewName;

            // Update tab active states
            const viewTabs = document.querySelectorAll('.view-tab');
            viewTabs.forEach(tab => {
                if (tab.dataset.view === viewName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Update view content visibility
            const timelineView = document.getElementById('timelineView');
            const cardsView = document.getElementById('cardsView');

            if (viewName === 'timeline') {
                timelineView.classList.add('active');
                cardsView.classList.remove('active');
            } else if (viewName === 'cards') {
                timelineView.classList.remove('active');
                cardsView.classList.add('active');

                // Load service cards if we have data
                if (statusData) {
                    renderServiceCards(statusData);
                } else {
                    // Load status data if we don't have it yet
                    loadStatus();
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadStatus();
            loadIncidents();

            // Load data based on view mode
            if (VIEW_MODE === 'timeline' || VIEW_MODE === 'both') {
                loadTimeline();
            }
            if (VIEW_MODE === 'cards') {
                // Cards will load when status loads
            }

            startAutoRefresh();

            // Set up view switcher tabs (only if view_mode is 'both')
            if (VIEW_MODE === 'both') {
                const viewTabs = document.querySelectorAll('.view-tab');
                viewTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        switchView(tab.dataset.view);
                    });
                });
            }

            // Set up filter buttons
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active state
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Update range and reload timeline
                    currentRange = btn.dataset.range;
                    loadTimeline();
                });
            });

            // Set up Show More button for incidents
            const showMoreBtn = document.getElementById('showMoreBtn');
            if (showMoreBtn) {
                showMoreBtn.addEventListener('click', toggleShowMore);
            }
        });
    </script>
</body>
</html>
